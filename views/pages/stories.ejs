<div class="max-w-6xl mx-auto">
  <!-- Stories Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold bg-gradient-to-r from-primary-500 to-secondary-500 text-transparent bg-clip-text">Stories</h1>
    <p class="text-dark-500 mt-2">Discover moments from people you follow</p>
  </div>
  
  <!-- Stories Tabs -->
  <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-8">
    <div class="flex border-b border-dark-100">
      <button class="flex-1 py-4 px-4 font-medium text-primary-500 border-b-2 border-primary-500 flex items-center justify-center">
        <i class="fas fa-globe mr-2"></i>
        <span>All Stories</span>
      </button>
      <button class="flex-1 py-4 px-4 font-medium text-dark-500 hover:text-dark-700 transition-colors flex items-center justify-center">
        <i class="fas fa-user mr-2"></i>
        <span>Your Stories</span>
      </button>
      <button class="flex-1 py-4 px-4 font-medium text-dark-500 hover:text-dark-700 transition-colors flex items-center justify-center">
        <i class="fas fa-archive mr-2"></i>
        <span>Archive</span>
      </button>
    </div>
  </div>
  
  <!-- Create Story Button (Mobile) -->
  <div class="md:hidden mb-6">
    <a href="/create-story" class="w-full py-3 px-4 bg-gradient-to-r from-primary-500 to-secondary-500 text-white font-medium rounded-xl hover:shadow-lg transition-all duration-200 flex items-center justify-center">
      <i class="fas fa-plus mr-2"></i>
      Create New Story
    </a>
  </div>
  
  <!-- Stories Grid -->
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mt-6" id="stories-grid">
    <!-- Stories will be loaded dynamically here -->
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', async function() {
    // Get current user
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
      window.location.href = '/login';
      return;
    }
    
    // Load all stories
    await loadAllStories(currentUser);
  });

  /**
   * Load all stories for the stories page
   * @param {Object} currentUser - The current user
   */
  async function loadAllStories(currentUser) {
    try {
      const storiesGrid = document.getElementById('stories-grid');
      storiesGrid.innerHTML = ''; // Clear existing content
      
      // Show loading state
      storiesGrid.innerHTML = `
        <div class="col-span-full text-center py-10">
          <p class="text-lg text-gray-500">Loading stories...</p>
          <div class="mt-4 inline-block">
            <i class="fas fa-spinner fa-spin text-primary-500 text-2xl"></i>
          </div>
        </div>
      `;
      
      // Fetch stories from db.json
      const response = await fetch('http://localhost:3001/stories');
      
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
      }
      
      const stories = await response.json();
      
      // Clear loading state
      storiesGrid.innerHTML = '';
      
      // Filter active stories (not expired)
      const now = new Date().toISOString();
      const activeStories = stories.filter(story => story.expiresAt > now);
      
      // Sort stories by creation date (newest first)
      activeStories.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      // Create HTML for each story
      for (const story of activeStories) {
        try {
          // Get user data
          const userResponse = await fetch(`http://localhost:3001/users/${story.userId}`);
          
          // Check if user exists
          if (!userResponse.ok) {
            console.warn(`User with ID ${story.userId} not found, skipping story`);
            continue;
          }
          
          const user = await userResponse.json();
          
          // Calculate time ago
          const timeAgo = getTimeAgo(story.createdAt);
          
          // Create story element
          const storyElement = document.createElement('div');
          storyElement.className = 'relative group cursor-pointer';
          storyElement.innerHTML = `
            <div class="aspect-[3/4] w-full rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-all">
              <img src="${story.media.url}" alt="${user.name}'s story" class="w-full h-full object-cover">
              <div class="absolute rounded-2xl inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
              
              <!-- Story Header -->
              <div class="absolute top-3 left-3 right-3">
                <div class="flex items-center">
                  <div class="w-8 h-8 rounded-full border-2 border-primary-500 overflow-hidden">
                    <img src="${user.avatar}" alt="${user.name}" class="w-full h-full object-cover">
                  </div>
                  <div class="ml-2">
                    <p class="text-white text-xs font-medium">${user.name}</p>
                    <p class="text-white/70 text-xs">${timeAgo}</p>
                  </div>
                </div>
              </div>
              
              <!-- Story Footer -->
              <div class="absolute bottom-3 left-3 right-3">
                <p class="text-white text-sm line-clamp-2">${story.caption || 'No caption'}</p>
              </div>
            </div>
          `;
          
          // Add click event to view story
          storyElement.addEventListener('click', () => {
            viewStory(story, user, currentUser);
          });
          
          // Add to grid
          storiesGrid.appendChild(storyElement);
        } catch (userError) {
          console.error(`Error processing story ${story.id}:`, userError);
          // Skip this story and continue with others
        }
      }
      
      // If no stories, show message
      if (storiesGrid.children.length === 0) {
        storiesGrid.innerHTML = `
          <div class="col-span-full text-center py-10">
            <p class="text-lg text-gray-500">No stories available</p>
            <a href="/create-story" class="mt-4 inline-block px-4 py-2 bg-primary-500 text-white rounded-lg">Create a Story</a>
          </div>
        `;
      }
      
    } catch (error) {
      console.error('Error loading all stories:', error);
      const storiesGrid = document.getElementById('stories-grid');
      storiesGrid.innerHTML = `
        <div class="col-span-full text-center py-10">
          <p class="text-lg text-red-500">Error loading stories: ${error.message}</p>
          <p class="mt-2 text-dark-500">Make sure your JSON server is running with:</p>
          <pre class="mt-2 bg-dark-100 p-2 rounded text-sm">npx json-server --watch db.json --port 3001</pre>
          <button id="retry-load-stories" class="mt-4 px-4 py-2 bg-primary-500 text-white rounded-lg">
            <i class="fas fa-sync-alt mr-2"></i>Retry
          </button>
        </div>
      `;
      
      // Add retry button functionality
      const retryButton = document.getElementById('retry-load-stories');
      if (retryButton) {
        retryButton.addEventListener('click', () => {
          loadAllStories(currentUser);
        });
      }
    }
  }

  // Helper function to calculate time ago
  function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}d ago`;
    
    return date.toLocaleDateString();
  }
  </script>
  
  <!-- Load More Button -->
  <div class="flex justify-center mt-10 mb-10">
    <button class="px-6 py-2.5 border border-dark-200 text-dark-700 rounded-full hover:bg-dark-50 transition-colors flex items-center">
      <span>Load More</span>
      <i class="fas fa-spinner ml-2"></i>
    </button>
  </div>
</div>
