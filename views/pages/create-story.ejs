<div class="max-w-3xl mx-auto">
  <!-- Create Story Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold bg-gradient-to-r from-primary-500 to-secondary-500 text-transparent bg-clip-text">Create Story</h1>
    <p class="text-dark-500 mt-2">Share a moment that disappears after 24 hours</p>
  </div>

  <!-- Create Story Form -->
  <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6">
    <div class="p-6">
      <!-- User Info - Will be populated dynamically -->
      <div class="flex items-center space-x-3 mb-6">
        <div id="userInitials" class="w-12 h-12 rounded-full bg-primary-500 flex items-center justify-center text-white font-bold">
          <!-- User initials will be inserted here -->
        </div>
        <div>
          <h3 id="userName" class="font-semibold text-dark-900">
            <!-- User name will be inserted here -->
          </h3>
          <div class="flex items-center text-dark-500 text-sm">
            <i class="fas fa-globe-americas mr-1.5"></i>
            <select id="privacySelect" class="bg-transparent border-none focus:ring-0 p-0 pr-6 text-dark-500">
              <option value="Public">Public</option>
              <option value="Friends Only">Friends Only</option>
              <option value="Close Friends">Close Friends</option>
            </select>
            <i class="fas fa-chevron-down ml-1 text-xs"></i>
          </div>
        </div>
      </div>

      <!-- Story Preview -->
      <div class="mb-6">
        <div class="aspect-[9/16] max-h-[70vh] bg-dark-100 rounded-xl overflow-hidden relative flex items-center justify-center">
          <div id="storyPreview" class="w-full h-full flex items-center justify-center text-dark-400">
            <div class="text-center">
              <i class="fas fa-image text-6xl mb-4"></i>
              <p>Preview will appear here</p>
            </div>
          </div>
          <div id="previewOverlay" class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 transition-opacity"></div>
          <div id="previewText" class="absolute bottom-6 left-6 right-6 text-white opacity-0 transition-opacity">
            <p class="text-lg font-medium" id="previewCaption"></p>
          </div>
        </div>
      </div>

      <!-- Upload Area -->
      <div class="border-2 border-dashed border-dark-200 rounded-xl p-8 mb-6 text-center" id="uploadArea">
        <div class="mb-4">
          <i class="fas fa-cloud-upload-alt text-4xl text-dark-400"></i>
        </div>
        <h4 class="font-semibold text-dark-800 mb-2">Upload media for your story</h4>
        <p class="text-dark-500 text-sm mb-4">Support for images and videos (max 15 seconds)</p>
        <input type="file" id="storyMedia" accept="image/*,video/*" class="hidden">
        <button 
          id="chooseFileBtn"
          class="bg-primary-500 text-white px-6 py-2.5 rounded-full hover:bg-primary-600 transition-colors shadow-sm"
        >
          Choose File
        </button>
      </div>

      <!-- Caption Input -->
      <div class="mb-6">
        <label for="storyCaption" class="block text-sm font-medium text-dark-700 mb-2">Add a caption</label>
        <textarea 
          id="storyCaption" 
          placeholder="Write something..." 
          class="w-full border border-dark-200 rounded-xl p-4 min-h-[80px] focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all resize-none"
          maxlength="150"
          oninput="updatePreview()"
        ></textarea>
        <div class="flex justify-end mt-1">
          <span class="text-xs text-dark-500"><span id="captionLength">0</span>/150</span>
        </div>
      </div>

      <!-- Story Options -->
      <div class="border-t border-dark-100 pt-6">
        <h3 class="font-semibold mb-4 flex items-center">
          <i class="fas fa-sliders-h text-primary-500 mr-2"></i>
          Story Options
        </h3>
        
        <div class="space-y-4">
          <!-- Allow Replies -->
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-medium text-dark-900">Allow Replies</h4>
              <p class="text-dark-500 text-sm">Let people reply to your story</p>
            </div>
            
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" value="" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-dark-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-dark-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500"></div>
            </label>
          </div>
          
          <!-- Close Friends Only -->
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-medium text-dark-900">Close Friends Only</h4>
              <p class="text-dark-500 text-sm">Only show to people on your close friends list</p>
            </div>
            
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" value="" class="sr-only peer">
              <div class="w-11 h-6 bg-dark-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-dark-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500"></div>
            </label>
          </div>
          
          <!-- Hide View Count -->
          <div class="flex items-center justify-between">
            <div>
              <h4 class="font-medium text-dark-900">Hide View Count</h4>
              <p class="text-dark-500 text-sm">Don't show how many people viewed your story</p>
            </div>
            
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" value="" class="sr-only peer">
              <div class="w-11 h-6 bg-dark-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-dark-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-500"></div>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex justify-end space-x-3 mb-10">
    <a href="/" class="px-6 py-2.5 border border-dark-200 text-dark-700 rounded-full hover:bg-dark-50 transition-colors">
      Cancel
    </a>
    <button id="publishStory" class="px-6 py-2.5 bg-primary-500 text-white rounded-full hover:bg-primary-600 transition-colors shadow-sm">
      Share Story
    </button>
  </div>
</div>

<script src="/js/fileUploadService.js"></script>
<script>
  function updatePreview() {
    const captionInput = document.getElementById('storyCaption');
    const previewCaption = document.getElementById('previewCaption');
    const captionLength = document.getElementById('captionLength');
    
    if (captionInput && previewCaption && captionLength) {
      previewCaption.textContent = captionInput.value;
      captionLength.textContent = captionInput.value.length;
      
      // Show overlay and text if there's content
      const previewOverlay = document.getElementById('previewOverlay');
      const previewText = document.getElementById('previewText');
      
      if (previewOverlay && previewText) {
        if (captionInput.value.trim().length > 0) {
          previewOverlay.classList.add('opacity-100');
          previewText.classList.add('opacity-100');
        } else if (!document.getElementById('storyMedia').files[0]) {
          previewOverlay.classList.remove('opacity-100');
          previewText.classList.remove('opacity-100');
        }
      }
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const storyMedia = document.getElementById('storyMedia');
    const storyPreview = document.getElementById('storyPreview');
    const previewOverlay = document.getElementById('previewOverlay');
    const previewText = document.getElementById('previewText');
    const publishButton = document.getElementById('publishStory');
    const userInitialsElement = document.getElementById('userInitials');
    const userNameElement = document.getElementById('userName');
    
    // Get current user and update UI
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (currentUser) {
      // Update user info in the UI
      if (userInitialsElement) {
        // Get initials from name
        const initials = currentUser.name
          .split(' ')
          .map(n => n[0])
          .join('')
          .toUpperCase();
        userInitialsElement.textContent = initials;
      }
      
      if (userNameElement) {
        userNameElement.textContent = currentUser.name;
      }
      
      // Set user preferences if available
      if (currentUser.preferences) {
        const privacySelect = document.getElementById('privacySelect');
        if (privacySelect && currentUser.preferences.defaultPrivacy) {
          privacySelect.value = currentUser.preferences.defaultPrivacy;
        }
        
        // Set default story options if available
        const allowRepliesCheckbox = document.querySelector('input[type="checkbox"]:nth-of-type(1)');
        const closeFriendsOnlyCheckbox = document.querySelector('input[type="checkbox"]:nth-of-type(2)');
        const hideViewCountCheckbox = document.querySelector('input[type="checkbox"]:nth-of-type(3)');
        
        if (allowRepliesCheckbox && currentUser.preferences.allowReplies !== undefined) {
          allowRepliesCheckbox.checked = currentUser.preferences.allowReplies;
        }
        
        if (closeFriendsOnlyCheckbox && currentUser.preferences.closeFriendsOnly !== undefined) {
          closeFriendsOnlyCheckbox.checked = currentUser.preferences.closeFriendsOnly;
        }
        
        if (hideViewCountCheckbox && currentUser.preferences.hideViewCount !== undefined) {
          hideViewCountCheckbox.checked = currentUser.preferences.hideViewCount;
        }
      }
    } else {
      // Redirect to login if not logged in
      window.location.href = '/auth/login';
      return;
    }
    
    let selectedFile = null;
    
    if (storyMedia) {
      storyMedia.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        selectedFile = file;
        const reader = new FileReader();
        
        reader.onload = function(event) {
          if (file.type.startsWith('image/')) {
            storyPreview.innerHTML = `<img src="${event.target.result}" class="w-full h-full object-cover">`;
            previewOverlay.classList.add('opacity-100');
            previewText.classList.add('opacity-100');
          } else if (file.type.startsWith('video/')) {
            storyPreview.innerHTML = `
              <video src="${event.target.result}" class="w-full h-full object-cover" autoplay muted loop></video>
            `;
            previewOverlay.classList.add('opacity-100');
            previewText.classList.add('opacity-100');
          }
        };
        
        reader.readAsDataURL(file);
      });
    }
    
    publishButton.addEventListener('click', async function() {
      if (!selectedFile) {
        alert('Please select a media file for your story');
        return;
      }
      
      try {
        // Get story options
        const privacySelect = document.getElementById('privacySelect');
        const allowRepliesCheckbox = document.querySelector('input[type="checkbox"]:nth-of-type(1)');
        const closeFriendsOnlyCheckbox = document.querySelector('input[type="checkbox"]:nth-of-type(2)');
        const hideViewCountCheckbox = document.querySelector('input[type="checkbox"]:nth-of-type(3)');
        
        const privacy = privacySelect ? privacySelect.value : 'Public';
        const allowRepliesValue = allowRepliesCheckbox ? allowRepliesCheckbox.checked : true;
        const closeFriendsOnlyValue = closeFriendsOnlyCheckbox ? closeFriendsOnlyCheckbox.checked : false;
        const hideViewCountValue = hideViewCountCheckbox ? hideViewCountCheckbox.checked : false;
        
        // Get caption
        const caption = document.getElementById('storyCaption').value;
        
        // Upload the file
        const mediaUrl = await window.FileUploadService.saveFile(selectedFile, 'stories');
        if (!mediaUrl) {
          throw new Error('Failed to upload media');
        }
        
        // Create story with the file path
        const now = new Date();
        const expiresAt = new Date(now.getTime() + 24 * 60 * 60 * 1000).toISOString();
        
        const response = await fetch('http://localhost:3001/stories', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: currentUser.id,
            media: {
              type: selectedFile.type.startsWith('image/') ? 'image' : 'video',
              url: mediaUrl
            },
            caption: caption,
            privacy: privacy,
            settings: {
              allowReplies: allowRepliesValue,
              closeFriendsOnly: closeFriendsOnlyValue,
              hideViewCount: hideViewCountValue
            },
            views: [],
            createdAt: now.toISOString(),
            expiresAt: expiresAt
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to create story');
        }
        
        // Save user preferences if they've changed
        if (currentUser.preferences) {
          const preferencesChanged = 
            currentUser.preferences.defaultPrivacy !== privacy ||
            currentUser.preferences.allowReplies !== allowRepliesValue ||
            currentUser.preferences.closeFriendsOnly !== closeFriendsOnlyValue ||
            currentUser.preferences.hideViewCount !== hideViewCountValue;
            
          if (preferencesChanged) {
            currentUser.preferences = {
              ...currentUser.preferences,
              defaultPrivacy: privacy,
              allowReplies: allowRepliesValue,
              closeFriendsOnly: closeFriendsOnlyValue,
              hideViewCount: hideViewCountValue
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Update user preferences on server
            await fetch(`http://localhost:3001/users/${currentUser.id}`, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                preferences: currentUser.preferences
              })
            });
          }
        }
        
        // Redirect to home page
        window.location.href = '/';
      } catch (error) {
        console.error('Error publishing story:', error);
        alert('Failed to publish story. Please try again.');
      }
    });
  });
</script>
